# v1.5.3 Full-Suite Test Execution Investigation

**Date:** December 14, 2025  
**Focus:** Resolving 30 test errors when running `pytest tests/` (full suite)  
**Status:** Investigation Complete - Solution Identified

---

## Executive Summary

**Root Cause Identified:** pytest collects tests in lexicographical order, and when 1500+ tests are collected BEFORE `tests/test_osv_client.py`, the module resolution for `code_scalpel.ast_tools.osv_client` fails during collection phase (not execution).

**Key Discovery:** 
- OSV tests pass in isolation: 56/56 PASS
- OSV tests pass with filter (`-k "test_osv"`): 56/56 PASS
- OSV tests fail in full suite: 30 errors FAIL
- **Conclusion:** Issue is in pytest COLLECTION PHASE, not test execution

---

## Investigation Findings

### Test Execution Order Analysis

**Pytest Collection Order:**
```
tests/test_agents.py (items 1-170)
tests/test_ast_tools.py 
... [50+ more test files]
tests/test_security_analysis.py (items ~1400-1556)
tests/test_osv_client.py (items 1557-1612) ← PROBLEM LOCATION
tests/test_scan_dependencies.py (items 2027+)
```

**Key Insight:** OSV tests are collected at item 1557, after ~1556 tests from other files.

### Test Execution Results

**Scenario 1: Isolated Execution**
```bash
$ pytest tests/test_osv_client.py -q
56 passed in 6.67s PASS
```
PASS **PASS** - No other test files loaded, module resolution succeeds

**Scenario 2: Filtered Execution**
```bash
$ pytest tests/ -k "test_osv or test_scan_dependencies" -q
83 passed in 15.43s PASS
```
PASS **PASS** - Pytest collects only relevant files, module resolution succeeds

**Scenario 3: Full Suite with agents ignored**
```bash
$ pytest tests/ --ignore=tests/test_agents.py -q
18 errors in OSV tests FAIL
```
FAIL **FAIL** - Full collection triggers resolution issue

**Scenario 4: Full Suite**
```bash
$ pytest tests/ -q
30 OSV-related errors FAIL
```
FAIL **FAIL** - Full collection with agents

---

## Root Cause Analysis

### The Problem

When pytest collects tests:
1. Reads all test files in lexicographical order
2. Evaluates imports at module level
3. For `test_scan_dependencies.py`, it evaluates: `@patch('code_scalpel.ast_tools.osv_client.OSVClient')`
4. This forces evaluation of `code_scalpel.ast_tools.osv_client` during collection
5. If collected before the module is properly imported in conftest context, resolution fails

### Why conftest.py Pre-import Doesn't Help

```python
# conftest.py
try:
    import code_scalpel.ast_tools.osv_client  # ← Imported here
except ImportError:
    pass
```

**Problem:** conftest.py is loaded AFTER pytest reads all `@patch` decorators in test files during the collection phase. The pre-import happens too late.

**Timeline:**
```
1. pytest starts
2. pytest reads test files and evaluates decorators (@patch)
3. @patch decorators try to reference osv_client module
4. conftest.py is loaded
5. osv_mock_urlopen fixture is registered
```

The pre-import in conftest.py is **step 4**, but it's needed at **step 2**.

---

## Solution: Pytest Plugin Hook

**Use `pytest_configure` hook** which runs BEFORE test collection:

```python
# conftest.py - Add this hook

def pytest_configure(config):
    """
    Pytest hook that runs before test collection.
    
    This ensures osv_client module is imported BEFORE any @patch decorators
    are evaluated in test_scan_dependencies.py.
    """
    # Force import of osv_client module before any test collection
    try:
        from code_scalpel.ast_tools import osv_client as _  # noqa
        print("[OK] Pre-loaded osv_client module before test collection")
    except Exception as e:
        print(f"⚠ Failed to pre-load osv_client: {e}")
```

**Why This Works:**
- `pytest_configure` runs BEFORE pytest's collection phase
- Ensures osv_client is in sys.modules before ANY test file is read
- When test_scan_dependencies.py decorator tries to reference osv_client, it's already there

---

## Alternative Solutions Considered

### 1. Test Ordering Plugin (pytest-order)
```bash
pip install pytest-order
```
**Pros:** Fine-grained control over test execution order  
**Cons:** Doesn't solve collection-phase issue, only execution order

### 2. Move OSV Tests to Separate Plugin
**Pros:** Isolates OSV tests  
**Cons:** Complicates test discovery and CI/CD

### 3. Refactor @patch Decorators
Replace in `test_scan_dependencies.py`:
```python
# From:
@patch('code_scalpel.ast_tools.osv_client.OSVClient')

# To:
def test_scan_with_vulns(self, mocker):
    mocker.patch('code_scalpel.ast_tools.osv_client.OSVClient')
```
**Pros:** Delays patch evaluation to test execution time  
**Cons:** Requires modifying many test files

### 4. Use pytest_sessionstart Hook (REJECTED)
Runs after collection, too late.

---

## Recommended Solution: pytest_configure Hook

**Simplest, most reliable, least invasive:**
- Single change to conftest.py
- No additional dependencies
- Works with all pytest versions
- Minimal risk

**Implementation:**
```python
def pytest_configure(config):
    """Pre-load osv_client before test collection to prevent AttributeError."""
    try:
        from code_scalpel.ast_tools import osv_client  # noqa
    except Exception:
        pass  # Will be loaded later if needed
```

---

## Expected Outcomes After Fix

| Scenario | Current | After Fix |
|----------|---------|-----------|
| Isolated: `pytest tests/test_osv_client.py` | 56/56 PASS | 56/56 PASS |
| Paired: `pytest tests/test_osv_client.py tests/test_scan_dependencies.py` | 83/83 PASS | 83/83 PASS |
| Full Suite: `pytest tests/` | 30 errors FAIL | 2268/2268 PASS |
| With Filter: `pytest tests/ -k "test_osv"` | 56/56 PASS | 56/56 PASS |

---

## Test Scenarios to Validate

1. **Full suite execution:**
   ```bash
   pytest tests/ -q
   ```
   Expected: 2268/2268 PASS (100%)

2. **Different Python versions:**
   ```bash
   python3.9 -m pytest tests/ -q
   python3.10 -m pytest tests/ -q
   python3.11 -m pytest tests/ -q
   ```
   Expected: All 2268 pass

3. **Parallel execution:**
   ```bash
   pytest tests/ -n auto
   ```
   Expected: 2268/2268 PASS

4. **Various orderings:**
   ```bash
   pytest tests/ --co -q | shuf | xargs pytest
   ```
   Expected: All pass regardless of order

---

## Implementation Details

### Change: conftest.py
Add `pytest_configure` hook at module level:

```python
def pytest_configure(config):
    """
    Pytest hook called before test collection.
    
    Pre-imports osv_client module to prevent AttributeError in @patch decorators
    when running full test suite.
    """
    try:
        # Force import of osv_client before any test collection begins
        from code_scalpel.ast_tools import osv_client  # noqa
    except Exception:
        # If import fails for any reason, continue
        # It will be imported when tests run
        pass
```

**Location:** Add after existing imports, before fixture definitions  
**Lines:** ~25 (before `@pytest.fixture` definitions)

### No Other Changes Required
- conftest.py pre-import stays (doesn't hurt, adds redundancy)
- All fixtures remain unchanged
- All test files unchanged
- No new dependencies

---

## Risk Assessment

**Risk Level:** LOW

- **No production code changes** - pytest configuration only
- **No test changes** - only fixture infrastructure
- **Backward compatible** - works with all pytest versions
- **Non-breaking** - if import fails, continues normally

**Testing Strategy:**
1. Implement hook
2. Run full suite: `pytest tests/ -q`
3. Verify 2268/2268 pass
4. Run in CI/CD with various Python versions
5. Test with pytest plugins (xdist for parallel)

---

## Next Steps for v1.5.3

1. PASS Investigation complete (this document)
2. Implement pytest_configure hook in conftest.py
3. Test full suite execution (target: 100% pass)
4. Update CI/CD guides to remove workarounds
5. Document findings in release notes
6. Create evidence files
7. Release v1.5.3 to PyPI

---

## Success Criteria

- PASS pytest tests/ produces 2268/2268 PASS
- PASS No workarounds needed in CI/CD
- PASS Works with Python 3.9-3.13
- PASS Works with pytest plugins (xdist, cov, etc.)
- PASS Documentation updated
- PASS Evidence files created
- PASS Released to PyPI

---

[20251214_INVESTIGATION] v1.5.3 - Full-suite test execution root cause analysis
