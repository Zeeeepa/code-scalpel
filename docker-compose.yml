# Code Scalpel Server - Docker Compose v3.0.0
# Supports MCP-compliant server with HTTP and HTTPS
# [20251218_DOCS] Updated to v3.0.0 Autonomy release

version: '3.8'

services:
  # MCP server with HTTP (for local development)
  # Use this for local testing without SSL certificates
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: code-scalpel:3.0.0
    container_name: code-scalpel-mcp
    restart: unless-stopped
    ports:
      - "8593:8593"
      - "8594:8594"  # Health endpoint
    volumes:
      # Mount your project directory to /workspace for analysis
      - ${CODE_SCALPEL_WORKSPACE:-.}:/workspace
    networks:
      - code-scalpel-network
    environment:
      - WORKSPACE_ROOT=/workspace
      - PROJECT_ROOT=/workspace
      - SCALPEL_ROOT=/workspace
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8594/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # [20251216_DOCS] MCP server with HTTPS (for production/Claude API)
  # Requires SSL certificates mounted to /certs
  # Generate self-signed certs: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout key.pem -out cert.pem
  mcp-server-https:
    build:
      context: .
      dockerfile: Dockerfile
    image: code-scalpel:3.0.0
    container_name: code-scalpel-mcp-https
    restart: unless-stopped
    ports:
      - "8443:8593"   # HTTPS MCP endpoint
      - "8444:8594"   # HTTPS Health endpoint
    volumes:
      # Mount your project directory
      - ${CODE_SCALPEL_WORKSPACE:-.}:/workspace
      # Mount SSL certificates (required for HTTPS)
      - ${SSL_CERT_DIR:-./certs}:/certs:ro
    networks:
      - code-scalpel-network
    environment:
      - WORKSPACE_ROOT=/workspace
      - PROJECT_ROOT=/workspace
      - SCALPEL_ROOT=/workspace
      - PYTHONUNBUFFERED=1
      # SSL certificate paths inside container
      - SSL_CERT=/certs/cert.pem
      - SSL_KEY=/certs/key.pem
    healthcheck:
      # Use HTTPS for health check when SSL is enabled
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8594/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # REST API server (legacy, for non-MCP clients)
  # Provides simple HTTP endpoints for code analysis
  rest-api:
    build:
      context: .
      dockerfile: Dockerfile.rest
    image: code-scalpel-rest:2.2.0
    container_name: code-scalpel-rest
    restart: unless-stopped
    ports:
      - "8595:5000"
    volumes:
      - ${CODE_SCALPEL_WORKSPACE:-.}:/workspace
    networks:
      - code-scalpel-network
    environment:
      - FLASK_ENV=production
      - WORKSPACE_ROOT=/workspace
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  code-scalpel-network:
    driver: bridge
