name: Publish GitHub Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to publish (e.g., v3.2.3)'
        required: true
        default: 'v3.2.3'

permissions:
  contents: write

jobs:
  build-artifacts:
    name: Build Distribution Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Extract version from tag
        id: extract_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_NAME="${{ inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi

          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format: $TAG_NAME (expected vX.Y.Z)"
            exit 1
          fi

          VERSION="${TAG_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Verify version matches pyproject.toml
        run: |
          TOML_VERSION=$(python -c "import tomllib; f = open('pyproject.toml', 'rb'); print(tomllib.load(f)['project']['version'])")
          TAG_VERSION=${{ steps.extract_version.outputs.version }}

          if [ "$TOML_VERSION" != "$TAG_VERSION" ]; then
            echo "::warning::Version mismatch!"
            echo "   pyproject.toml: $TOML_VERSION"
            echo "   Git tag:        $TAG_VERSION"
            echo "Proceeding with tag version: $TAG_VERSION"
          else
            echo "✅ Version verified: $TAG_VERSION"
          fi

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twine

      - name: Build MCPB bundle
        run: |
          python scripts/build_mcpb.py
          ls -lh dist/

      - name: Verify MCPB bundle
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}

          # Check that MCPB was created
          if [ ! -f dist/codescalpel-${VERSION}.mcpb ]; then
            echo "::error::MCPB not found: dist/codescalpel-${VERSION}.mcpb"
            ls -la dist/
            exit 1
          fi

          echo "✅ MCPB bundle verified"

          # Verify MCPB contents include manifest.json and MCP server
          echo "Checking MCPB contents..."
          unzip -l dist/codescalpel-${VERSION}.mcpb | grep -E "(manifest.json|pyproject.toml|code_scalpel/mcp|limits.toml|features.toml)"

          # Extract and validate manifest.json
          unzip -p dist/codescalpel-${VERSION}.mcpb manifest.json | python -m json.tool > /dev/null
          echo "✅ Manifest JSON valid"

      - name: Generate checksums
        run: |
          cd dist
          sha256sum codescalpel-${{ steps.extract_version.outputs.version }}.mcpb > checksums.txt
          cat checksums.txt

      - name: Generate Claude Desktop installation instructions
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}

          cat > dist/CLAUDE_DESKTOP_INSTALL.md <<EOF
          # Code Scalpel v${VERSION} for Claude Desktop

          ## Quick Install (One-Click)

          **Option 1: MCPB Bundle (Recommended)**
          1. Download \`codescalpel-${VERSION}.mcpb\` from this release
          2. Double-click the .mcpb file to install in Claude Desktop
          3. Restart Claude Desktop
          4. Open new conversation and type: "List Code Scalpel tools"

          **Option 2: Manual uvx Setup**
          \`\`\`bash
          # Install via uvx
          uvx codescalpel
          \`\`\`

          Then add to \`claude_desktop_config.json\`:

          **macOS**: \`~/Library/Application Support/Claude/claude_desktop_config.json\`
          **Windows**: \`%APPDATA%\\Claude\\claude_desktop_config.json\`
          **Linux**: \`~/.config/Claude/claude_desktop_config.json\`

          \`\`\`json
          {
            "mcpServers": {
              "code-scalpel": {
                "command": "uvx",
                "args": ["codescalpel", "mcp"]
              }
            }
          }
          \`\`\`

          ## Verify Installation

          1. Restart Claude Desktop completely
          2. Open new conversation
          3. Type: "List available Code Scalpel tools"
          4. You should see 23+ MCP tools

          ## What's Included

          - 23 MCP tools for code analysis
          - Security scanning with taint analysis
          - Symbolic execution (Z3 solver)
          - Cross-file dependency analysis
          - Type evaporation detection
          - Policy compliance checking

          ## Documentation

          - [Full Documentation](https://github.com/3D-Tech-Solutions/code-scalpel/blob/v${VERSION}/docs/deployment/ides/claude-desktop.md)
          - [MCP Tools Reference](https://github.com/3D-Tech-Solutions/code-scalpel#mcp-tools)
          - [Troubleshooting](https://github.com/3D-Tech-Solutions/code-scalpel/blob/v${VERSION}/docs/deployment/ides/claude-desktop.md#troubleshooting)

          ## Checksums (SHA256)

          \`\`\`
          $(cat dist/checksums.txt)
          \`\`\`
          EOF

          echo "✅ Generated Claude Desktop install instructions"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-${{ steps.extract_version.outputs.version }}
          path: dist/
          retention-days: 90

  github-release:
    name: Create GitHub Release
    needs: build-artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve tag + release notes path
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_NAME="${{ inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi

          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format: $TAG_NAME (expected vX.Y.Z)"
            exit 1
          fi

          VERSION="${TAG_NAME#v}"
          NOTES_PATH="docs/release_notes/RELEASE_NOTES_v${VERSION}.md"

          # Prefer the release notes as they exist in the tag itself.
          # This ensures the release body matches the tagged source.
          if git cat-file -e "refs/tags/$TAG_NAME:$NOTES_PATH" 2>/dev/null; then
            git show "refs/tags/$TAG_NAME:$NOTES_PATH" > release_notes.md
            echo "Using release notes from tag: $TAG_NAME ($NOTES_PATH)"
          elif [[ -f "$NOTES_PATH" ]]; then
            # Fallback for legacy tags created before notes existed.
            echo "::warning::Release notes not present in tag $TAG_NAME; using current branch file: $NOTES_PATH"
            cp "$NOTES_PATH" release_notes.md
          else
            echo "::warning::Release notes file not found: $NOTES_PATH"
            echo "Generating default release notes..."

            cat > release_notes.md <<EOF
          ## Code Scalpel ${VERSION}

          ### Installation

          #### Via uvx (Recommended)
          \`\`\`bash
          uvx codescalpel
          \`\`\`

          #### Via pip
          \`\`\`bash
          pip install codescalpel==${VERSION}
          \`\`\`

          #### From wheel
          \`\`\`bash
          pip install codescalpel-${VERSION}-py3-none-any.whl
          \`\`\`

          ### Claude Desktop Setup

          See attached \`CLAUDE_DESKTOP_INSTALL.md\` for complete configuration instructions.

          ### What's Included

          - 22+ MCP tools for code analysis
          - Security scanning with taint analysis
          - Symbolic execution (Z3 solver)
          - Cross-file dependency analysis
          - Type evaporation detection
          - Policy compliance checking

          ### Documentation

          - [Installation Guide](https://github.com/3D-Tech-Solutions/code-scalpel/blob/v${VERSION}/docs/deployment/CLAUDE_DESKTOP_v${VERSION}.md)
          - [Claude Desktop Setup](https://github.com/3D-Tech-Solutions/code-scalpel/blob/v${VERSION}/docs/deployment/ides/claude-desktop.md)
          EOF
          fi

          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "notes_path=release_notes.md" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: distribution-${{ needs.build-artifacts.outputs.version }}
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.tag_name }}
          name: Code Scalpel ${{ steps.resolve.outputs.tag_name }}
          body_path: ${{ steps.resolve.outputs.notes_path }}
          files: |
            dist/codescalpel-${{ needs.build-artifacts.outputs.version }}.mcpb
            dist/checksums.txt
            dist/CLAUDE_DESKTOP_INSTALL.md
          draft: false
          prerelease: false
