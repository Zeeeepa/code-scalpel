name: Publish Docker Images

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to publish (e.g., v1.2.3)'
        required: true
      registry:
        description: 'Docker registry (ghcr.io or docker.io)'
        required: false
        default: 'ghcr.io'

permissions:
  packages: write
  contents: read

jobs:
  build-and-publish:
    name: Build & Publish Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine tag and registry
        id: config
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
            REGISTRY="${{ inputs.registry }}"
          else
            TAG="${{ github.ref_name }}"
            REGISTRY="ghcr.io"
          fi

          VERSION="${TAG#v}"

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format: $TAG (expected vX.Y.Z)"
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Code Scalpel
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: steps.config.outputs.registry == 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        if: steps.config.outputs.registry == 'docker.io'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          python - << 'PY'
          from code_scalpel.release.docker_builder import DockerImageBuilder

          version = "${{ steps.config.outputs.version }}"
          registry = "${{ steps.config.outputs.registry }}"

          print(f"Building Docker images for {version}")
          print(f"Registry: {registry}")

          builder = DockerImageBuilder(
              version=version,
              registry=registry,
          )

          result = builder.publish_release(skip_push=False, dry_run=False)

          print("\nâœ… Docker images published successfully!")
          print(f"Version tag: {result['version']}")
          print(f"Images built: {len(result['images_built'])}")
          print(f"Images pushed: {len(result['images_pushed'])}")

          for img in result['images_pushed']:
              print(f"  - {img}")
          PY

      - name: Create release summary
        run: |
          echo "## Docker Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.config.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry**: ${{ steps.config.outputs.registry }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images**:" >> $GITHUB_STEP_SUMMARY
          echo "- code-scalpel:${{ steps.config.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- code-scalpel:latest" >> $GITHUB_STEP_SUMMARY
          echo "- code-scalpel-rest:${{ steps.config.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- code-scalpel-rest:latest" >> $GITHUB_STEP_SUMMARY
