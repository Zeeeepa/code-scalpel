name: Automated Release Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'CHANGELOG.md'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (auto/major/minor/patch)'
        required: false
        default: 'auto'
      skip_github:
        description: 'Skip GitHub release creation'
        required: false
        default: 'false'
      skip_pypi:
        description: 'Skip PyPI publishing'
        required: false
        default: 'false'
      skip_docker:
        description: 'Skip Docker image publishing'
        required: false
        default: 'false'
      skip_vscode:
        description: 'Skip VS Code extension publishing'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Detect if this is a release commit and get version info
  detect-release:
    name: Detect Release
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      
      - name: Fix git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Check if release commit
        id: check
        shell: bash
        run: |
          set -euo pipefail
          
          # Check if pyproject.toml was modified
          if git diff HEAD~1 HEAD --name-only | grep -q "pyproject.toml"; then
            VERSION=$(grep "^version = " pyproject.toml | sed 's/version = "\(.*\)"/\1/')
            TAG="v${VERSION}"
            
            # Check if tag already exists (avoid re-releasing)
            if git rev-parse "refs/tags/$TAG" &>/dev/null; then
              echo "::notice::Tag $TAG already exists, skipping release"
              echo "is_release=false" >> "$GITHUB_OUTPUT"
            else
              echo "::notice::Detected release: $VERSION"
              echo "is_release=true" >> "$GITHUB_OUTPUT"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
              echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

  # Run full CI pipeline
  ci:
    name: CI Pipeline
    needs: [detect-release]
    if: always()
    uses: ./.github/workflows/ci.yml
    
  # Create git tag and GitHub release
  create-release:
    name: Create Release Tag
    needs: [detect-release, ci]
    if: needs.detect-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      
      - name: Generate release notes
        run: |
          python - << 'PY'
          import subprocess
          import sys
          from pathlib import Path
          from code_scalpel.release.orchestrator import ReleaseOrchestrator
          
          orchestrator = ReleaseOrchestrator()
          
          # Get release plan
          prep = orchestrator.execute_release(dry_run=False)
          
          if prep['bump_type'] != 'NONE':
              version = prep['new_version']
              notes = prep['release_notes']
              
              # Write release notes to file
              notes_file = Path(f"docs/release_notes/RELEASE_NOTES_v{version}.md")
              notes_file.parent.mkdir(parents=True, exist_ok=True)
              notes_file.write_text(notes)
              
              print(f"Generated release notes: {notes_file}")
          PY
      
      - name: Create and push tag
        run: |
          VERSION="${{ needs.detect-release.outputs.version }}"
          TAG="${{ needs.detect-release.outputs.tag }}"
          
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions"
          
          # Tag with release notes
          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"
          
          echo "::notice::Created and pushed tag: $TAG"

  # Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    needs: [detect-release, create-release]
    if: |
      needs.detect-release.outputs.is_release == 'true' &&
      github.event.inputs.skip_pypi != 'true'
    uses: ./.github/workflows/publish-pypi.yml
    with:
      tag: ${{ needs.detect-release.outputs.tag }}
    secrets: inherit

  # Create GitHub release
  publish-github:
    name: Create GitHub Release
    needs: [detect-release, create-release]
    if: |
      needs.detect-release.outputs.is_release == 'true' &&
      github.event.inputs.skip_github != 'true'
    uses: ./.github/workflows/publish-github-release.yml
    with:
      tag: ${{ needs.detect-release.outputs.tag }}
    secrets: inherit

  # Build and publish Docker images
  publish-docker:
    name: Publish Docker Images
    needs: [detect-release, create-release]
    if: |
      needs.detect-release.outputs.is_release == 'true' &&
      github.event.inputs.skip_docker != 'true'
    uses: ./.github/workflows/publish-docker.yml
    with:
      tag: ${{ needs.detect-release.outputs.tag }}
    secrets: inherit

  # Publish VS Code extension
  publish-vscode:
    name: Publish VS Code Extension
    needs: [detect-release, create-release]
    if: |
      needs.detect-release.outputs.is_release == 'true' &&
      github.event.inputs.skip_vscode != 'true'
    uses: ./.github/workflows/publish-vscode.yml
    with:
      tag: ${{ needs.detect-release.outputs.tag }}
    secrets: inherit

  # Summary
  release-summary:
    name: Release Summary
    needs: [detect-release, publish-pypi, publish-github, publish-docker, publish-vscode]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Print release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.detect-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ needs.detect-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- CI: ${{ needs.ci.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PyPI: ${{ needs.publish-pypi.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub: ${{ needs.publish-github.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.publish-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- VS Code: ${{ needs.publish-vscode.result }}" >> $GITHUB_STEP_SUMMARY
