# Configuration

Code Scalpel can be configured through environment variables, configuration files, and runtime parameters.

## Environment Variables

### Core Settings

#### `SCALPEL_PROJECT_ROOT`
**Type:** Path  
**Default:** Current working directory  
**Description:** Root directory of the project to analyze.

```bash
SCALPEL_PROJECT_ROOT=/path/to/your/project
```

#### `SCALPEL_TIER`
**Type:** String (`community` | `pro` | `enterprise`)  
**Default:** `community`  
**Description:** Tier level for feature access and limits.

```bash
SCALPEL_TIER=community
```

#### `SCALPEL_LICENSE_PATH`
**Type:** Path  
**Default:** `./license.jwt`  
**Description:** Path to JWT license file (Pro/Enterprise only).

```bash
SCALPEL_LICENSE_PATH=/secure/location/license.jwt
```

### Policy & Security

#### `SCALPEL_MANIFEST_SECRET`
**Type:** String (HMAC secret)  
**Required:** Yes (for `verify_policy_integrity`)  
**Description:** HMAC secret for cryptographic verification of policy files.

```bash
SCALPEL_MANIFEST_SECRET=your-generated-secret-here
```

**Security Model: FAIL CLOSED**
- Missing secret → DENY ALL operations
- Invalid signature → DENY ALL operations
- Hash mismatch → DENY ALL operations

**Generation:**
```bash
# Generate secure secret during initialization
python -m code_scalpel init

# This creates .env with:
# SCALPEL_MANIFEST_SECRET={randomly-generated-secret}
```

**CRITICAL: Production Deployment**
1. Copy secret to CI/CD system (GitHub Secrets, AWS Secrets Manager, etc.)
2. **NEVER commit the actual secret to git**
3. Add `.env` to `.gitignore`
4. Rotate secret if compromised
5. After rotation: `code-scalpel regenerate-manifest`

#### `SCALPEL_POLICY_DIR`
**Type:** Path  
**Default:** `./policies`  
**Description:** Directory containing policy definition files.

```bash
SCALPEL_POLICY_DIR=/project/security/policies
```

#### `SCALPEL_SANDBOX_ENABLED`
**Type:** Boolean  
**Default:** `false`  
**Description:** Enable sandboxed execution for code operations.

```bash
SCALPEL_SANDBOX_ENABLED=true
```

### Performance & Limits

#### `SCALPEL_MAX_FILE_SIZE`
**Type:** Integer (bytes)  
**Default:** `10485760` (10 MB)  
**Description:** Maximum file size to analyze.

```bash
SCALPEL_MAX_FILE_SIZE=20971520  # 20 MB
```

#### `SCALPEL_MAX_COMPLEXITY`
**Type:** Integer  
**Default:** `100`  
**Description:** Maximum cyclomatic complexity threshold.

```bash
SCALPEL_MAX_COMPLEXITY=150
```

#### `SCALPEL_CACHE_ENABLED`
**Type:** Boolean  
**Default:** `true`  
**Description:** Enable AST caching for faster repeated operations.

```bash
SCALPEL_CACHE_ENABLED=true
```

#### `SCALPEL_CACHE_DIR`
**Type:** Path  
**Default:** `./.code_scalpel_cache`  
**Description:** Directory for cached AST data.

```bash
SCALPEL_CACHE_DIR=/tmp/code_scalpel_cache
```

### Logging & Debugging

#### `SCALPEL_LOG_LEVEL`
**Type:** String (`DEBUG` | `INFO` | `WARNING` | `ERROR`)  
**Default:** `INFO`  
**Description:** Logging verbosity level.

```bash
SCALPEL_LOG_LEVEL=DEBUG
```

#### `SCALPEL_ENABLE_TRACING`
**Type:** Boolean  
**Default:** `false`  
**Description:** Enable detailed operation tracing (performance impact).

```bash
SCALPEL_ENABLE_TRACING=true
```

### MCP Transport

#### `SCALPEL_TRANSPORT`
**Type:** String (`stdio` | `http` | `sse`)  
**Default:** `stdio`  
**Description:** MCP transport protocol.

```bash
SCALPEL_TRANSPORT=http
```

#### `SCALPEL_HTTP_PORT`
**Type:** Integer  
**Default:** `8000`  
**Description:** HTTP server port (when using http/sse transport).

```bash
SCALPEL_HTTP_PORT=8080
```

#### `SCALPEL_HTTP_HOST`
**Type:** String  
**Default:** `127.0.0.1`  
**Description:** HTTP server bind address.

```bash
SCALPEL_HTTP_HOST=0.0.0.0  # Listen on all interfaces
```

## Configuration Files

### `.env` File

Create a `.env` file in your project root:

```bash
# Generated by: code-scalpel init
# Documentation: https://github.com/3D-Tech-Solutions/code-scalpel/wiki/Configuration

# ========================================================================
# PROJECT CONFIGURATION
# ========================================================================
SCALPEL_PROJECT_ROOT=/path/to/project
SCALPEL_TIER=community

# ========================================================================
# POLICY INTEGRITY VERIFICATION
# ========================================================================
# CRITICAL: Required for verify_policy_integrity to work
# 
# Security Model: FAIL CLOSED
# - Missing secret -> DENY ALL
# - Invalid signature -> DENY ALL
# - Hash mismatch -> DENY ALL
#
# GENERATED SECRET (DO NOT COMMIT):
SCALPEL_MANIFEST_SECRET=your-secret-here
#
# PRODUCTION DEPLOYMENT:
# 1. Copy to CI/CD secrets (GitHub Secrets, etc.)
# 2. Never commit to git
# 3. Rotate if compromised
# 4. After rotation: code-scalpel regenerate-manifest
# ========================================================================

# ========================================================================
# PERFORMANCE
# ========================================================================
SCALPEL_MAX_FILE_SIZE=10485760
SCALPEL_CACHE_ENABLED=true
SCALPEL_CACHE_DIR=./.code_scalpel_cache

# ========================================================================
# LOGGING
# ========================================================================
SCALPEL_LOG_LEVEL=INFO
SCALPEL_ENABLE_TRACING=false

# ========================================================================
# MCP TRANSPORT
# ========================================================================
SCALPEL_TRANSPORT=stdio
# SCALPEL_HTTP_PORT=8000
# SCALPEL_HTTP_HOST=127.0.0.1
```

### Initialize Configuration

```bash
# Create .env with secure defaults
python -m code_scalpel init

# This generates:
# - .env file with random SCALPEL_MANIFEST_SECRET
# - .gitignore entry for .env
# - Default policy directory structure
```

### `pyproject.toml` Integration

Code Scalpel can read configuration from `pyproject.toml`:

```toml
[tool.code-scalpel]
project_root = "."
tier = "community"
max_file_size = 10485760
cache_enabled = true

[tool.code-scalpel.security]
sandbox_enabled = false
policy_dir = "./policies"

[tool.code-scalpel.logging]
level = "INFO"
enable_tracing = false
```

## Tier Configuration

### Community Tier (Default)

Free and open-source (MIT License):

```bash
SCALPEL_TIER=community
```

**Limits:**
- Security findings: 50 per scan
- Symbol references: 100 per query
- Call graph nodes: 500 per analysis
- Project files: 1,000 files
- Test generation: 10 paths

**Features:**
- All 22 tools available ✅
- AST parsing ✅
- Taint analysis ✅
- Symbolic execution ✅
- Basic reporting ✅

### Pro Tier

Commercial license required:

```bash
SCALPEL_TIER=pro
SCALPEL_LICENSE_PATH=/secure/pro-license.jwt
```

**Limits:**
- Security findings: Unlimited
- Symbol references: Unlimited
- Call graph nodes: 10,000 per analysis
- Project files: 10,000 files
- Test generation: 50 paths

**Additional Features:**
- Cross-file security scanning ✅
- Advanced metrics ✅
- Priority support ✅
- Custom rules ✅

### Enterprise Tier

Enterprise license required:

```bash
SCALPEL_TIER=enterprise
SCALPEL_LICENSE_PATH=/secure/enterprise-license.jwt
```

**Limits:**
- All unlimited

**Additional Features:**
- Compliance reporting (HIPAA, SOC2, GDPR, PCI-DSS) ✅
- PDF compliance certificates ✅
- Audit trails ✅
- Custom policies ✅
- SLA support ✅
- On-premise deployment ✅

## Docker Configuration

### Environment Variables in Docker

```bash
docker run -i \
  -e SCALPEL_PROJECT_ROOT=/workspace \
  -e SCALPEL_TIER=community \
  -e SCALPEL_LOG_LEVEL=DEBUG \
  -v $(pwd):/workspace \
  3dtechsolutions/code-scalpel:latest
```

### Docker Compose

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  code-scalpel:
    image: 3dtechsolutions/code-scalpel:latest
    environment:
      - SCALPEL_PROJECT_ROOT=/workspace
      - SCALPEL_TIER=community
      - SCALPEL_LOG_LEVEL=INFO
      - SCALPEL_CACHE_ENABLED=true
      - SCALPEL_MANIFEST_SECRET=${SCALPEL_MANIFEST_SECRET}
    volumes:
      - ./:/workspace
      - cache:/cache
    stdin_open: true
    tty: true

volumes:
  cache:
```

Run with:
```bash
# Set secret in environment
export SCALPEL_MANIFEST_SECRET="your-secret"

# Start service
docker-compose up
```

## MCP Client Configuration

### VS Code / GitHub Copilot

`.vscode/mcp.json`:

```json
{
  "mcpServers": {
    "code-scalpel": {
      "command": "python",
      "args": ["-m", "code_scalpel.mcp.server"],
      "env": {
        "SCALPEL_PROJECT_ROOT": "${workspaceFolder}",
        "SCALPEL_TIER": "community",
        "SCALPEL_LOG_LEVEL": "INFO",
        "SCALPEL_CACHE_ENABLED": "true"
      }
    }
  }
}
```

### Claude Desktop

`claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "code-scalpel": {
      "command": "python",
      "args": ["-m", "code_scalpel.mcp.server"],
      "env": {
        "SCALPEL_PROJECT_ROOT": "/path/to/project",
        "SCALPEL_TIER": "community",
        "SCALPEL_MANIFEST_SECRET": "your-secret-here"
      }
    }
  }
}
```

**Security Warning:** For Claude Desktop, consider using environment variable expansion:

```json
{
  "env": {
    "SCALPEL_MANIFEST_SECRET": "${SCALPEL_SECRET}"
  }
}
```

Then set `SCALPEL_SECRET` in your system environment.

## Advanced Configuration

### Custom Policy Rules

Create `policies/custom.yaml`:

```yaml
version: "1.0"
policies:
  - id: "CUSTOM001"
    name: "No hardcoded credentials"
    pattern: "(password|api_key|secret)\\s*=\\s*['\"]\\w+"
    severity: "critical"
    message: "Hardcoded credentials detected"
  
  - id: "CUSTOM002"
    name: "Require type hints"
    check: "missing_type_hints"
    severity: "warning"
    message: "Functions should have type hints"
```

Reference in `.env`:
```bash
SCALPEL_POLICY_DIR=./policies
```

### Symbolic Execution Tuning

Fine-tune Z3 solver behavior:

```bash
# Maximum paths to explore
SCALPEL_SYMBOLIC_MAX_PATHS=20

# Path exploration timeout (seconds)
SCALPEL_SYMBOLIC_TIMEOUT=30

# Loop unrolling depth
SCALPEL_SYMBOLIC_LOOP_DEPTH=3
```

### Performance Optimization

For large projects:

```bash
# Enable aggressive caching
SCALPEL_CACHE_ENABLED=true
SCALPEL_CACHE_TTL=3600  # 1 hour

# Increase limits
SCALPEL_MAX_FILE_SIZE=52428800  # 50 MB
SCALPEL_MAX_WORKERS=8  # Parallel processing

# Disable expensive features if not needed
SCALPEL_ENABLE_SYMBOLIC=false
SCALPEL_ENABLE_TRACING=false
```

## Configuration Priority

Settings are applied in this order (later overrides earlier):

1. Built-in defaults
2. `pyproject.toml`
3. `.env` file
4. Environment variables
5. MCP client configuration
6. Runtime parameters

## Troubleshooting Configuration

### Check Active Configuration

```bash
python -m code_scalpel config show
```

### Validate Configuration

```bash
python -m code_scalpel config validate
```

### Reset to Defaults

```bash
python -m code_scalpel config reset
```

---

**Next Steps:**
- [MCP Tools Reference](MCP-Tools-Reference) - Use the tools with your configuration
- [Security](Security) - Policy enforcement and integrity verification
- [Troubleshooting](Troubleshooting) - Common configuration issues

